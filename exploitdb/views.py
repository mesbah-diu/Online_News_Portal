
from django.http import HttpResponse,HttpResponseRedirect, response
from django.shortcuts import render
from exploitdb.models import Registration, Contact
import requests
API_KEY = '437bd9a013d94f788562eefb28a161d4'

def index(request):
    url = '/home'

    if request.method == 'POST':
        email = request.POST['email']
        psw = request.POST['psw']
        userprofile = Registration.objects.get(email = email)
        if userprofile:
            if userprofile.psw == psw:
                print("loged In")
                return HttpResponseRedirect(url)
            else :
                print("Password doesnot match")
        else :
            print("Account doesnot found")
    return render(request, 'index.html')

def about(request):
    return HttpResponse('About mesbah')

def registration(request):
    if request.method == 'POST':      
        name = request.POST['name']
        email = request.POST['email']
        phone = request.POST['phone']
        psw = request.POST['psw']
        print(name, email, phone, psw)
        ins = Registration.objects.create(name=name, email=email, phone=phone, psw=psw)
        #ins.create()
        print(ins)
        print("This data has been save to the db")
    return render(request, 'registration.html')

def contact(request):
    if request.method=='POST':
        firstname=request.POST['firstname']
        lastname=request.POST['lastname']
        subject=request.POST['subject']
        obj = Contact.objects.create(firstname=firstname, lastname=lastname, subject=subject)
        print(obj)
    return render(request, 'news_api/contact.html')

def home(request):
    country = request.GET.get('country')
    category = request.GET.get('category')

    if country:
        url = f'https://newsapi.org/v2/top-headlines?country={country}&apiKey={API_KEY}'
        response = requests.get(url)
        data = response.json()
        articles = data['articles']
    else:
        url = f'https://newsapi.org/v2/top-headlines?category={category}&apiKey={API_KEY}'
        response = requests.get(url)
        data = response.json()
        articles = data['articles']


    context = {
        'articles' : articles
    }

    return render(request, 'news_api/home.html', context)